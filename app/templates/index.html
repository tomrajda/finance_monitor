{% extends "layout.html" %}

{% block content %}
<div class="row mb-3 align-items-center">
    <div class="col-lg-6 col-md-12 mb-3 mb-lg-0">
        <h2>bilans finansowy - {{ current_month_name }} {{ selected_year }}</h2>
    </div>
    <div class="col-lg-6 col-md-12">
        <div class="d-flex justify-content-lg-end justify-content-center align-items-center flex-wrap">
            <form method="GET" action="{{ url_for('main.index') }}" class="form-inline align-items-center mr-lg-2 mb-2 mb-lg-0">
                <div class="form-group mr-2 mb-0">
                    <label for="month_select" class="sr-only">Miesiąc:</label>
                    <select name="month" id="month_select" class="form-control form-control-sm">
                        {% for month_num, month_name_val in months %}
                        <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name_val }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mr-2 mb-0">
                    <label for="year_select" class="sr-only">Rok:</label>
                    <select name="year" id="year_select" class="form-control form-control-sm">
                        {% for year_val in years %}
                        <option value="{{ year_val }}" {% if year_val == selected_year %}selected{% endif %}>{{ year_val }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-sm btn-primary mb-0">Pokaż</button>
            </form>
            <button id="generateGeminiSummaryBtn" class="btn btn-sm btn-outline-primary btn-rounded mb-2 mb-lg-0 ml-lg-2" title="Generuj podsumowanie i porady AI dla wybranego miesiąca">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                  <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                </svg>
                <span class="d-none d-lg-inline ml-1">Porady AI</span>
                <span class="d-lg-none ml-1">ai</span>
            </button>
        </div>
    </div>
</div>
<div id="geminiSummarySection" style="display: none;">
    <hr class="my-3">
    <div id="geminiSummaryContainer" class="row mt-2">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center"><h4>podsumowanie i zalecenia (gemini ai)</h4><button type="button" class="close" aria-label="Close" id="closeGeminiSummaryBtn" title="zamknij podsumowanie"><span aria-hidden="true">×</span></button></div>
                <div class="card-body"><div id="geminiSummaryContent" class="gemini-summary"></div></div>
            </div>
        </div>
    </div>
    <hr class="my-4">
</div>
<h4>Podsumowanie</h4>
<div class="row">
    <div class="col-md-4"><div class="card text-white bg-success mb-3"><div class="card-header">Przychody</div><div class="card-body text-center"><h3 class="card-title display-4">{{ "%.2f"|format(total_income) }}</h3><p class="card-text">PLN</p></div></div></div>
    <div class="col-md-4"><div class="card text-white bg-danger mb-3"><div class="card-header">Wydatki</div><div class="card-body text-center"><h3 class="card-title display-4">{{ "%.2f"|format(total_expenses_raw) }}</h3><p class="card-text">PLN</p></div></div></div>
    <div class="col-md-4"><div class="card text-white {% if savings_total_month >= 0 %}bg-info{% else %}bg-warning{% endif %} mb-3"><div class="card-header">Oszczędności</div><div class="card-body text-center"><h3 class="card-title display-4">{{ "%.2f"|format(savings_total_month) }}</h3><p class="card-text">PLN</p></div></div></div>
</div>
<div class="row mt-1 mb-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><h5 class="mb-0 text-center">YTD</h5></div>
            <div class="card-body p-3">
                <div class="row text-center">
                    <div class="col-md-3 mb-2 mb-md-0"><p class="text-muted mb-0"><small>Przychody </small></p><h4 class="text-success font-weight-bold mb-0">{{ "%.2f"|format(total_income_ytd_couple) }} <small>PLN</small></h4></div>
                    <div class="col-md-3 mb-2 mb-md-0"><p class="text-muted mb-0"><small>Wydatki </small></p><h4 class="text-danger font-weight-bold mb-0">{{ "%.2f"|format(total_expenses_raw_ytd_couple) }} <small>PLN</small></h4></div>
                    <div class="col-md-3 mb-2 mb-md-0"><p class="text-muted mb-0"><small>Oszczędności </small></p><h4 class="font-weight-bold mb-0 {% if savings_ytd_total_couple >= 0 %}text-info{% else %}text-warning{% endif %}">{{ "%.2f"|format(savings_ytd_total_couple) }} <small>PLN</small></h4></div>
                    <div class="col-md-3"><p class="text-muted mb-0"><small>Średnie wydatki</small></p><h4 class="text-secondary font-weight-bold mb-0">{{ "%.2f"|format(average_monthly_expenses_ytd_couple) }} <small>PLN</small></h4></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-3">
                 <div class="row text-center">
                    <div class="col-md-6 mb-2 mb-md-0 border-right"><p class="text-muted mb-0"><small>Oszczędności 🐻</small></p><h4 class="font-weight-bold mb-0 {% if savings_ytd_tomek >= 0 %}text-primary{% else %}text-secondary{% endif %}">{{ "%.2f"|format(savings_ytd_tomek) }} <small>PLN</small></h4></div>
                    <div class="col-md-6"><p class="text-muted mb-0"><small>Oszczędności 🍑</small></p><h4 class="font-weight-bold mb-0 {% if savings_ytd_tocka >= 0 %}text-primary{% else %}text-secondary{% endif %}">{{ "%.2f"|format(savings_ytd_tocka) }} <small>PLN</small></h4></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header"><h4>Trendy miesięczne: przychody vs wydatki </h4></div>
            <div class="card-body chart-container" style="height: 380px;">
                <div id="monthlyTrendsDataContainer" data-chartdata='{{ monthly_trends_data|tojson|safe }}' style="height: 100%; width: 100%;">
                    <canvas id="monthlyTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<hr class="my-4">
<h4>Podsumowanie indywidualne ({{ current_month_name }} {{ selected_year }})</h4>
<div class="row">
    <div class="col-md-6">
        <h5>{{ PERSON_TOMEK }} 🐻</h5>
        <div class="card mb-3"><div class="card-body"><p>przychód: <strong class="float-right">{{ "%.2f"|format(income_tomek) }} PLN</strong></p><hr><p class="text-muted mb-1"><small>składowe wydatków:</small></p><p class="ml-3 mb-0"><small>wydatki prywatne:</small> <strong class="float-right">{{ "%.2f"|format(private_expenses_tomek) }} PLN</strong></p><p class="ml-3"><small>udział w wydatkach wspólnych:</small> <strong class="float-right">{{ "%.2f"|format(tomek_share_of_shared_expenses) }} PLN</strong></p><hr><p><strong>suma wydatków:</strong> <strong class="float-right">{{ "%.2f"|format(total_expenses_tomek) }} PLN</strong></p><hr><p><strong>oszczędności:</strong> <strong class="float-right {% if savings_tomek >= 0 %}text-success{% else %}text-danger{% endif %}">{{ "%.2f"|format(savings_tomek) }} PLN</strong></p></div></div>
        <div class="card"><div class="card-header">🐻 wydatki wg kategorii</div><div class="card-body chart-container" style="height: 320px;">{% if expenses_tomek_by_category_dict %}<div id="expensesTomekDataContainer" data-chartdata='{{ expenses_tomek_by_category_dict|tojson|safe }}' style="height: 100%; width: 100%;"><canvas id="expensesTomekChart"></canvas></div>{% else %}<p class="text-muted text-center mt-3">Brak wydatków.</p>{% endif %}</div></div>
    </div>
    <div class="col-md-6">
        <h5>{{ PERSON_TOCKA }} 🍑</h5>
        <div class="card mb-3"><div class="card-body"><p>przychód: <strong class="float-right">{{ "%.2f"|format(income_tocka) }} PLN</strong></p><hr><p class="text-muted mb-1"><small>składowe wydatków:</small></p><p class="ml-3 mb-0"><small>wydatki prywatne:</small> <strong class="float-right">{{ "%.2f"|format(private_expenses_tocka) }} PLN</strong></p><p class="ml-3"><small>udział w wydatkach wspólnych:</small> <strong class="float-right">{{ "%.2f"|format(tocka_share_of_shared_expenses) }} PLN</strong></p><hr><p><strong>suma wydatków:</strong> <strong class="float-right">{{ "%.2f"|format(total_expenses_tocka) }} PLN</strong></p><hr><p><strong>oszczędności:</strong> <strong class="float-right {% if savings_tocka >= 0 %}text-success{% else %}text-danger{% endif %}">{{ "%.2f"|format(savings_tocka) }} PLN</strong></p></div></div>
        <div class="card"><div class="card-header">🍑 wydatki wg kategorii</div><div class="card-body chart-container" style="height: 320px;">{% if expenses_tocka_by_category_dict %}<div id="expensesTockaDataContainer" data-chartdata='{{ expenses_tocka_by_category_dict|tojson|safe }}' style="height: 100%; width: 100%;"><canvas id="expensesTockaChart"></canvas></div>{% else %}<p class="text-muted text-center mt-3">Brak wydatków.</p>{% endif %}</div></div>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-12"><div class="card"><div class="card-header"><h4>Rozkład wydatków  (wszystkie kategorie - {{ current_month_name }} {{ selected_year }})</h4></div><div class="card-body chart-container" style="height: 400px;">{% if expenses_by_category_overall_dict %}<div id="expensesByCategoryOverallDataContainer" data-chartdata='{{ expenses_by_category_overall_dict|tojson|safe }}' style="height: 100%; width: 100%;"><canvas id="expensesByCategoryOverallChart"></canvas></div>{% else %}<p class="text-muted text-center mt-3">Brak wydatków w tej kategorii.</p>{% endif %}</div></div></div>
</div>
<div class="row mt-4">
    <div class="col-md-12"><div class="card"><div class="card-header"><h4>Transakcje ({{ current_month_name }} {{ selected_year }})</h4></div><div class="card-body p-0">{% if transactions %}<div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th>data</th><th>opis</th><th class="text-right">kwota</th><th>typ</th><th>kategoria</th><th>konto</th><th>osoba</th></tr></thead><tbody>{% for t in transactions %}<tr class="{{ 'table-success-row' if t.is_income else 'table-danger-row' }}"><td>{{ t.date.strftime('%d-%m-%Y') }}</td><td>{{ t.description or "-" }}</td><td class="text-right font-weight-bold">{{ "%.2f"|format(t.amount) }} PLN</td><td><span class="badge badge-{{ 'success' if t.is_income else 'danger' }}">{{ "przychód" if t.is_income else "wydatek" }}</span></td><td>{{ t.category.name if t.category else '-' }}</td><td>{{ t.account.name }}</td><td>{{ t.person }}</td></tr>{% endfor %}</tbody></table></div>{% else %}<p class="text-center text-muted p-3">Brak transakcji w wybranym okresie.</p>{% endif %}</div></div></div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const categoryColorMapJson = '{{ category_color_map|tojson|safe }}';
    let categoryColorMap = {}; 
    try {
        if (categoryColorMapJson && categoryColorMapJson.trim() !== "" && categoryColorMapJson.trim() !== "{}") {
            categoryColorMap = JSON.parse(categoryColorMapJson);
        }
    } catch (e) {
        console.error("błąd parsowania categoryColorMapJson:", e, "json string:", categoryColorMapJson);
    }

    const modernColorsFallback = [
        'rgba(255, 99, 132, 0.85)',  // Różowy/Czerwony
        'rgba(54, 162, 235, 0.85)',  // Niebieski
        'rgba(255, 206, 86, 0.85)',  // Żółty
        'rgba(75, 192, 192, 0.85)',  // Turkusowy/Teal
        'rgba(153, 102, 255, 0.85)', // Fioletowy
        'rgba(255, 159, 64, 0.85)',  // Pomarańczowy
        'rgba(76, 175, 80, 0.85)',   // Zielony
        'rgba(201, 203, 207, 0.85)', // Szary
        'rgba(230, 126, 34, 0.85)',  // Ciemny Pomarańczowy (Carrot)
        'rgba(46, 204, 113, 0.85)',  // Szmaragdowy
        'rgba(142, 68, 173, 0.85)',  // Ciemny Fiolet (Wisteria)
        'rgba(241, 196, 15, 0.85)',  // Słonecznikowy Żółty
        'rgba(26, 188, 156, 0.85)',  // Turkusowy
        'rgba(231, 76, 60, 0.85)',   // Ciemny Czerwony (Alizarin)
        'rgba(52, 73, 94, 0.85)',    // Ciemny Niebiesko-Szary (Wet Asphalt)
        'rgba(127, 140, 141, 0.85)', // Szary (Asbestos)
        'rgba(0, 184, 148, 0.85)',   // Mint
        'rgba(253, 203, 110, 0.85)', // Orange Yellow
        'rgba(9, 132, 227, 0.85)',   // Peter River Blue
        'rgba(211, 84, 0, 0.85)'     // Pumpkin
    ];
    let fallbackColorIndex = 0; 

    function getCategoryColor(categoryName) {
        if (categoryColorMap && categoryColorMap[categoryName]) {
            return categoryColorMap[categoryName];
        }
        const color = modernColorsFallback[fallbackColorIndex % modernColorsFallback.length];
        fallbackColorIndex++;
        return color;
    }

    function getBorderColorsFromBg(backgroundColors) {
        return backgroundColors.map(color => {
            const parts = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
            if (parts) {
                return `rgba(${Math.max(0, parseInt(parts[1]) - 15)}, ${Math.max(0, parseInt(parts[2]) - 15)}, ${Math.max(0, parseInt(parts[3]) - 15)}, 1)`;
            }
            if (color.startsWith('rgb(')) {
                 const rgbParts = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                 if (rgbParts) {
                    return `rgb(${Math.max(0, parseInt(rgbParts[1]) - 15)}, ${Math.max(0, parseInt(rgbParts[2]) - 15)}, ${Math.max(0, parseInt(rgbParts[3]) - 15)})`;
                 }
            }
            return color.replace(/[\d.]+\)$/g, '1)'); 
        });
    }
    

    function createChart(canvasId, chartType, dataContainerId, labelText, chartOptionsOverrides = {}) {
        const ctx = document.getElementById(canvasId);
        const dataContainer = document.getElementById(dataContainerId);

        if (!ctx || !dataContainer) { return null; }

        let rawDataString = dataContainer.dataset.chartdata;
        let rawData;
        try {
            rawData = (rawDataString && rawDataString.trim() !== "" && rawDataString.trim() !== "{}") ? JSON.parse(rawDataString) : {};
        } catch (e) {
            console.error(`Error parsing JSON for ${dataContainerId}:`, e, "Raw data string:", rawDataString);
            rawData = {};
        }
        
        let isEmptyData = true;
        if (chartType === 'line') {
            isEmptyData = !rawData.labels || rawData.labels.length === 0 || 
                          ((!rawData.incomes || rawData.incomes.length === 0) && 
                           (!rawData.expenses || rawData.expenses.length === 0));
        } else { 
            isEmptyData = Object.keys(rawData).length === 0;
        }

        if (isEmptyData) { 
            let existingChart = Chart.getChart(ctx);
            if (existingChart) { existingChart.destroy(); }
            return null; 
        }

        let chartLabels, datasetsConfig;
        let finalChartType = chartType;

        if (chartType === 'line' && rawData.labels) { 
            chartLabels = rawData.labels;
            datasetsConfig = [
                { label: 'Przychody (PLN)', data: rawData.incomes || [], borderColor: 'rgba(76, 175, 80, 1)', backgroundColor: 'rgba(76, 175, 80, 0.3)', tension: 0.3, fill: 'start', pointRadius: 4, pointHoverRadius: 6, pointBackgroundColor: 'rgba(76, 175, 80, 1)' },
                { label: 'Wydatki (PLN)', data: rawData.expenses || [], borderColor: 'rgba(239, 83, 80, 1)', backgroundColor: 'rgba(239, 83, 80, 0.3)', tension: 0.3, fill: 'start', pointRadius: 4, pointHoverRadius: 6, pointBackgroundColor: 'rgba(239, 83, 80, 1)' }
            ];
        } else if ((chartType === 'pie' || chartType === 'doughnut' || chartType === 'bar') && Object.keys(rawData).length > 0) {
            chartLabels = Object.keys(rawData); 
            const dataValues = Object.values(rawData);
            
            const backgroundColors = chartLabels.map(label => getCategoryColor(label));
            const borderColors = getBorderColorsFromBg(backgroundColors);

            datasetsConfig = [{
                label: labelText || 'Dane', 
                data: dataValues,
                backgroundColor: backgroundColors,
                borderColor: borderColors, 
                borderWidth: (chartType === 'pie' || chartType === 'doughnut') ? 2 : 1.5,
                hoverBorderColor: borderColors.map(c => c.replace('1)', '0.8)')), 
                hoverBorderWidth: (chartType === 'pie' || chartType === 'doughnut') ? 2.5 : 2,
                hoverOffset: (chartType === 'pie' || chartType === 'doughnut') ? 10 : 4
            }];
            if (chartType === 'bar') {
                datasetsConfig[0].borderRadius = 6;
                datasetsConfig[0].borderSkipped = false;
            }
        } else { 
            return null;
        }

        let baseChartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true, 
                    position: (chartType === 'pie' || chartType === 'doughnut') ? 'bottom' : 'top',
                    labels: { font: { family: 'Poppins', size: 11, weight: '500' }, padding: (chartType === 'pie' || chartType === 'doughnut') ? 20 : 10, boxWidth: 15, usePointStyle: (chartType === 'pie' || chartType === 'doughnut') },
                    onHover: (event, legendItem, legend) => { const chart = legend.chart; if (chart.getDatasetMeta(legendItem.datasetIndex)) { chart.getDatasetMeta(legendItem.datasetIndex).data[legendItem.index].hidden = false; chart.update(); } event.native.target.style.cursor = 'pointer'; },
                    onLeave: (event, legendItem, legend) => { event.native.target.style.cursor = 'default'; }
                },
                tooltip: {
                    enabled: true, backgroundColor: 'rgba(30,30,30,0.85)', 
                    titleFont: { family: 'Poppins', size: 13, weight: '600' },
                    bodyFont: { family: 'Poppins', size: 12 },
                    padding: 12, cornerRadius: 6,
                    displayColors: (chartType === 'pie' || chartType === 'doughnut'),
                    borderColor: 'rgba(255,255,255,0.05)', borderWidth: 0.5,
                    boxPadding: 3,
                    callbacks: {
                        label: function(context) {
                            let label = ''; let value;
                            if (chartType === 'pie' || chartType === 'doughnut') { label = context.label || ''; value = context.parsed; } 
                            else if (chartType === 'line') { label = context.dataset.label || ''; value = context.parsed.y; } 
                            else if (finalChartType === 'bar') { label = context.label || ''; value = context.chart.options.indexAxis === 'y' ? context.parsed.x : context.parsed.y; }
                            if (label) { label += ': '; }
                            if (value !== null && value !== undefined) { label += new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(value); }
                            if ((chartType === 'pie' || chartType === 'doughnut') && context.dataset.data) {
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0%';
                                label += ` (${percentage})`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {},
            layout: { padding: { top: 5, right: 10, bottom: 5, left: 10 } }
        };
        
        if (chartType === 'doughnut') { baseChartOptions.cutout = '60%'; }

        if (finalChartType === 'bar') { 
            if (chartOptionsOverrides.indexAxis === 'y' || !chartOptionsOverrides.indexAxis) { 
                baseChartOptions.indexAxis = 'y'; 
                baseChartOptions.scales = { x: { beginAtZero: true, grid: { drawBorder: false, color: "rgba(0,0,0,0.08)" }, ticks: { font: { family: 'Poppins' }, padding: 8 } }, y: { grid: { display: false }, ticks: { font: { family: 'Poppins', size: 10 }, padding: 5 } } };
            } else { 
                 baseChartOptions.indexAxis = 'x';
                 baseChartOptions.scales = { y: { beginAtZero: true, grid: { drawBorder: false, color: "rgba(0,0,0,0.08)" }, ticks: { font: { family: 'Poppins' }, padding: 8 } }, x: { grid: { display: false }, ticks: { font: { family: 'Poppins', size: 10 }, padding: 5 } } };
            }
            if (chartType !== 'stackedBar') baseChartOptions.plugins.legend.display = false;
        } else if (chartType === 'line') {
            baseChartOptions.scales = { y: { beginAtZero: false, grid: { color: "rgba(0,0,0,0.08)", drawBorder: false }, ticks: { font: { family: 'Poppins' }, padding: 8 } }, x: { grid: { display: false }, ticks: { font: { family: 'Poppins' }, padding: 5 } } };
            baseChartOptions.interaction = { mode: 'index', intersect: false }; 
        }
        
        const finalChartOptions = { ...baseChartOptions, ...chartOptionsOverrides };
        
        try {
            let existingChart = Chart.getChart(ctx);
            if (existingChart) { existingChart.destroy(); }
            return new Chart(ctx, { type: finalChartType, data: { labels: chartLabels, datasets: datasetsConfig }, options: finalChartOptions });
        } catch (chartError) { console.error(`Error creating chart ${canvasId}:`, chartError); return null; }
    }

    if (document.getElementById('expensesByCategoryOverallDataContainer')) { createChart('expensesByCategoryOverallChart', 'bar', 'expensesByCategoryOverallDataContainer', 'wydatki', {indexAxis: 'y'}); }
    if (document.getElementById('expensesTomekDataContainer')) { createChart('expensesTomekChart', 'doughnut', 'expensesTomekDataContainer', 'wydatki {{ PERSON_TOMEK }}'); }
    if (document.getElementById('expensesTockaDataContainer')) { createChart('expensesTockaChart', 'doughnut', 'expensesTockaDataContainer', 'wydatki {{ PERSON_TOCKA }}'); }

    const trendsDataContainerJS = document.getElementById('monthlyTrendsDataContainer');
    if (trendsDataContainerJS) {
        const chartDataAttrJS = trendsDataContainerJS.dataset.chartdata;
        if (chartDataAttrJS && chartDataAttrJS.trim() !== "" && chartDataAttrJS !== "{}") {
            try {
                const trendsDataJS = JSON.parse(chartDataAttrJS);
                if (trendsDataJS && trendsDataJS.labels && trendsDataJS.labels.length > 0 && ( (trendsDataJS.incomes && trendsDataJS.incomes.length > 0) || (trendsDataJS.expenses && trendsDataJS.expenses.length > 0) ) ) {
                    createChart('monthlyTrendsChart', 'line', 'monthlyTrendsDataContainer', null);
                }
            } catch(e) { /* console.error("Error in trends chart logic:", e); */ }
        }
    }
    
    const generateGeminiBtnJS = document.getElementById('generateGeminiSummaryBtn');
    const geminiSummarySection = document.getElementById('geminiSummarySection'); 
    const geminiSummaryContentJS = document.getElementById('geminiSummaryContent');
    const closeGeminiSummaryBtn = document.getElementById('closeGeminiSummaryBtn'); 
    
    if (generateGeminiBtnJS && geminiSummarySection && geminiSummaryContentJS && closeGeminiSummaryBtn) {
        const selectedYearForSummaryJS = document.getElementById('year_select').value; 
        const selectedMonthForSummaryJS = document.getElementById('month_select').value;
        
        generateGeminiBtnJS.addEventListener('click', async function() {
            this.disabled = true;
            const originalButtonHtml = this.innerHTML; 
            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> generowanie...`;
            
            geminiSummaryContentJS.innerHTML = '<p class="text-info">pobieranie podsumowania od ai...</p>';
            geminiSummarySection.style.display = 'block'; 

            try {
                const response = await fetch(`{{ url_for('main.api_get_gemini_summary') }}?year=${selectedYearForSummaryJS}&month=${selectedMonthForSummaryJS}`);
                const data = await response.json();
                if (response.ok) {
                    geminiSummaryContentJS.innerHTML = data.summary_html;
                } else {
                    geminiSummaryContentJS.innerHTML = data.summary_html || `<p class="text-danger">wystąpił błąd: ${data.error || 'nieznany błąd serwera'}</p>`;
                }
            } catch (error) {
                geminiSummaryContentJS.innerHTML = '<p class="text-danger">nie można połączyć się z serwerem, aby pobrać podsumowanie.</p>';
            } finally {
                this.disabled = false;
                this.innerHTML = originalButtonHtml; 
            }
        });

        closeGeminiSummaryBtn.addEventListener('click', function() {
            geminiSummarySection.style.display = 'none'; 
        });
    }
});
</script>
{% endblock %}