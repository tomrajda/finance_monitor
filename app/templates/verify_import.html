{% extends "layout.html" %}

{% block content %}
<style>
    .table-responsive { max-height: 70vh; }
    thead th { position: sticky; top: 0; background: var(--light-bg); z-index: 1; }
    /* Styl dla przycisku usuwania */
    .delete-tx-btn {
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s ease-in-out;
        font-size: 1.2rem; /* Powiększenie ikonki */
    }
    .delete-tx-btn:hover {
        opacity: 1;
        color: var(--danger);
    }
</style>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2>weryfikacja importu (<span id="transactionCounter">{{ transactions|length }}</span> transakcji)</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.verify_import', task_id=task.id) }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="importAccountSelect" class="font-weight-bold">Konto:</label>
                                <select id="importAccountSelect" name="import_account_id" class="form-control" required>
                                    <option value="">-- Wybierz konto --</option>
                                    {% for acc in accounts %}
                                        <option value="{{ acc.id }}">{{ acc.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="importPersonSelect" class="font-weight-bold">Osoba:</label>
                                <select id="importPersonSelect" name="import_person" class="form-control" required>
                                    <option value="">-- Wybierz osobę --</option>
                                    <option value="{{ PERSON_TOMEK }}">{{ PERSON_TOMEK }}</option>
                                    <option value="{{ PERSON_TOCKA }}">{{ PERSON_TOCKA }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <hr>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Opis</th>
                                    <th class="text-right">Kwota</th>
                                    <th style="min-width: 250px;">Kategoria</th>
                                    <th></th> <!-- NOWA KOLUMNA DLA PRZYCISKU USUWANIA -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr data-tx-id="{{ tx.id }}">
                                    <td>{{ tx.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <small>{{ tx.description }}</small><br>
                                        {% if tx.transaction_type == 'EXPENSE' %}
                                        <span class="badge badge-info">Gemini: {{ tx.suggested_category_name }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right font-weight-bold {% if tx.transaction_type == 'INCOME' %}text-success{% else %}text-danger{% endif %}">
                                        {{ "%.2f"|format(tx.amount) }} PLN
                                    </td>
                                    <td>
                                        {% if tx.transaction_type == 'EXPENSE' %}
                                            <select name="tx-{{ tx.id }}-category" class="form-control form-control-sm category-select">
                                                <option value="">-- Wybierz z listy --</option>
                                                {% for cat in categories %}
                                                <option value="{{ cat.id }}" {% if cat.id == tx.preselected_category_id %}selected{% endif %}>{{ cat.name }}</option>
                                                {% endfor %}
                                                <option value="new_category" {% if tx.is_new_suggestion %}selected{% endif %}>-- Stwórz nową... --</option>
                                            </select>
                                            <input type="text" 
                                                   name="tx-{{ tx.id }}-new_category_name" 
                                                   class="form-control form-control-sm mt-1 new-category-input {% if not tx.is_new_suggestion %}d-none{% endif %}" 
                                                   placeholder="Nazwa nowej kategorii" 
                                                   value="{% if tx.is_new_suggestion %}{{ tx.suggested_category_name }}{% endif %}">
                                        {% else %}
                                            <span class="text-muted font-italic"></span>
                                            <input type="hidden" name="tx-{{ tx.id }}-category" value="">
                                        {% endif %}
                                    </td>
                                    <!-- NOWA KOMÓRKA Z PRZYCISKIEM USUWANIA -->
                                    <td class="align-middle text-center">
                                        <i class="bi bi-x-circle-fill delete-tx-btn" data-tx-id="{{ tx.id }}" title="Usuń tę transakcję z importu"></i>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-success float-right mt-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-circle" viewBox="0 0 16 16"><path d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0z"/><path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l7-7z"/></svg>
                        Zatwierdź
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Skrypt do obsługi 'Stwórz nową...'
    document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', function() {
            const row = this.closest('tr');
            const newInput = row.querySelector('.new-category-input');
            const isNew = this.value === 'new_category';
            
            newInput.classList.toggle('d-none', !isNew);
            if (isNew) {
                newInput.setAttribute('required', 'required');
                newInput.focus();
            } else {
                newInput.removeAttribute('required');
            }
        });
    });

    // NOWY SKRYPT DO OBSŁUGI USUWANIA TRANSAKCJI
    document.querySelectorAll('.delete-tx-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            
            const txId = this.dataset.txId;
            const row = this.closest('tr');

            if (confirm('Czy na pewno chcesz usunąć tę transakcję z listy do importu?')) {
                fetch(`/import/delete_temp/${txId}`, {
                    method: 'DELETE',
                    headers: {
                        // Jeśli używasz CSRF, token byłby potrzebny tutaj
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        // Rzuć błąd, aby wszedł w blok .catch
                        return response.json().then(err => { throw new Error(err.message || 'Błąd serwera') });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        row.style.transition = 'opacity 0.5s ease';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            // Aktualizuj licznik transakcji
                            const counter = document.getElementById('transactionCounter');
                            if (counter) {
                                let currentCount = parseInt(counter.innerText) || 0;
                                counter.innerText = Math.max(0, currentCount - 1);
                            }
                        }, 500);
                    } else {
                        alert(`Błąd: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Błąd:', error);
                    alert(`Wystąpił błąd sieciowy lub błąd serwera: ${error.message}`);
                });
            }
        });
    });

});
</script>
{% endblock %}