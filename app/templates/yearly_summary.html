{% extends "layout.html" %}

{% block content %}
<style>
    /* Styl do centrowania canvasu wewnątrz kontenera */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
</style>

<div class="row mb-3 align-items-center">
    <div class="col-md-8">
        <h2>r.bilans</h2>
    </div>
    <div class="col-md-4">
        <form method="GET" action="{{ url_for('main.yearly_summary') }}" class="form-inline float-md-right">
            <div class="form-group mr-2 mb-2 mb-md-0">
                <label for="year_select" class="mr-2">Wybierz rok:</label>
                <select name="year" id="year_select" class="form-control form-control-sm" onchange="this.form.submit()">
                    {% for year_val in years_with_data %}
                    <option value="{{ year_val }}" {% if year_val == selected_year %}selected{% endif %}>{{ year_val }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Przychody</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_income_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Wydatki</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_expenses_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white {% if total_savings_ytd >= 0 %}bg-info{% else %}bg-warning{% endif %} mb-3">
            <div class="card-header">Oszczędności</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_savings_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header text-center">
                <h4>Rozkład wydatków</h4>
            </div>
            <div class="card-body chart-container" style="height: 600px;"> 
                {% if expenses_ytd_chart_data.labels %}
                    <div id="yearlyExpensesContainer" data-chartdata='{{ expenses_ytd_chart_data|tojson|safe }}' style="height: 100%; width: 100%;">
                        <canvas id="yearlyExpensesChart"></canvas>
                    </div>
                {% else %}
                    <p class="text-muted text-center mt-3">Brak wydatków w wybranym roku.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
window.addEventListener('load', function () {
    // Rejestracja pluginu do etykiet na wykresie
    if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
    }
    
    // ZMIANA: Usunięto rejestrację pluginu centerTextPlugin, bo nie jest już potrzebny
    // const centerTextPlugin = { ... };
    // Chart.register(centerTextPlugin);

    // Funkcje pomocnicze do kolorów
    const modernColorsFallback = [
        'rgba(255, 99, 132, 0.85)','rgba(54, 162, 235, 0.85)','rgba(255, 206, 86, 0.85)','rgba(75, 192, 192, 0.85)',
        'rgba(153, 102, 255, 0.85)','rgba(255, 159, 64, 0.85)','rgba(76, 175, 80, 0.85)','rgba(201, 203, 207, 0.85)'
    ];
    let colorIndex = 0;
    function getColor() {
        const color = modernColorsFallback[colorIndex % modernColorsFallback.length];
        colorIndex++;
        return color;
    }

    // Kod tworzący wykres
    const dataContainer = document.getElementById('yearlyExpensesContainer');
    const canvas = document.getElementById('yearlyExpensesChart');

    if (dataContainer && canvas) {
        let rawDataString = dataContainer.dataset.chartdata;
        let rawData;
        try { rawData = JSON.parse(rawDataString); } 
        catch (e) { rawData = {}; }

        if (rawData.labels && rawData.labels.length > 0) {
            const chartLabels = rawData.labels;
            const dataValues = rawData.data;
            const backgroundColors = chartLabels.map(() => getColor());
            const borderColors = backgroundColors.map(c => c.replace('0.85', '1'));

            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    parsing: false,
                    plugins: {
                        legend: { 
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed;
                                    if (label) { label += ': '; }
                                    label += new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(value);
                                    const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                    const percentage = (value / total * 100);
                                    label += ` (${percentage.toFixed(1)}%)`;
                                    return label;
                                }
                            }
                        },
                        // ZMIANA: Przywrócono pełną konfigurację datalabels
                        datalabels: {
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total * 100);
                                return percentage > 1.5 ? percentage.toFixed(1) + '%' : '';
                            },
                            color: '#fff',
                            font: { weight: 'bold', family: 'Poppins', size: 11 },
                            textStrokeColor: 'rgba(0,0,0,0.5)',
                            textStrokeWidth: 2
                        }
                        // ZMIANA: Usunięto obiekt 'centerText'
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}