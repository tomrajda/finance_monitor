{% extends "layout.html" %}

{% block content %}
<style>
    /* Styl do centrowania canvasu wewnątrz kontenera */
    .chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    #year_select {
        min-width: 80px; /* Dostosuj tę wartość, jeśli potrzeba */
    }
</style>

<div class="row mb-3 align-items-center">
    <div class="col-md-8">
        <h2>r.bilans</h2>
    </div>
    <div class="col-md-4">
        <form method="GET" action="{{ url_for('main.yearly_summary') }}" class="form-inline float-md-right">
            <div class="form-group mr-2 mb-2 mb-md-0">
                <label for="year_select" class="mr-2"></label>
                <select name="year" id="year_select" class="form-control form-control-sm" onchange="this.form.submit()">
                    {% for year_val in years_with_data %}
                    <option value="{{ year_val }}" {% if year_val == selected_year %}selected{% endif %}>{{ year_val }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Przychody</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_income_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Wydatki</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_expenses_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white {% if total_savings_ytd >= 0 %}bg-info{% else %}bg-warning{% endif %} mb-3">
            <div class="card-header">Oszczędności</div>
            <div class="card-body text-center">
                <h3 class="card-title display-4">{{ "%.2f"|format(total_savings_ytd) }}</h3>
                <p class="card-text">PLN</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header text-center">
                <h4>Rozkład wydatków</h4>
            </div>
            <div class="card-body chart-container" style="height: 600px;"> 
                {% if expenses_ytd_chart_data.labels %}
                    <div id="yearlyExpensesContainer" data-chartdata='{{ expenses_ytd_chart_data|tojson|safe }}' style="height: 100%; width: 100%;">
                        <canvas id="yearlyExpensesChart"></canvas>
                    </div>
                {% else %}
                    <p class="text-muted text-center mt-3">Brak wydatków w wybranym roku.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- NOWA SEKCJA: PODSUMOWANIE AI (GEMINI) -->
<div class="row mb-3">
    <div class="col-12 text-center">
        <button id="generateYearlySummaryBtn" class="btn btn-ai-gradient btn-rounded">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars mr-1" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/></svg>
            Gemini
        </button>
    </div>
</div>
<div id="geminiYearlySummaryContainer" class="row mt-2" style="display: none;">
    <div class="col-md-12">
        <div class="card"><div class="card-body"><div id="geminiYearlySummaryContent" class="gemini-summary"></div></div></div>
    </div>
</div>
<!-- KONIEC SEKCJI AI -->

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
window.addEventListener('load', function () {
    // Rejestracja pluginu do etykiet na wykresie
    if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
    }

    // Funkcje pomocnicze do kolorów
    const modernColorsFallback = [
        'rgba(255, 99, 132, 0.85)','rgba(54, 162, 235, 0.85)','rgba(255, 206, 86, 0.85)','rgba(75, 192, 192, 0.85)',
        'rgba(153, 102, 255, 0.85)','rgba(255, 159, 64, 0.85)','rgba(76, 175, 80, 0.85)','rgba(201, 203, 207, 0.85)'
    ];
    let colorIndex = 0;
    function getColor() {
        const color = modernColorsFallback[colorIndex % modernColorsFallback.length];
        colorIndex++;
        return color;
    }

    // Kod tworzący wykres
    const dataContainer = document.getElementById('yearlyExpensesContainer');
    const canvas = document.getElementById('yearlyExpensesChart');

    if (dataContainer && canvas) {
        let rawDataString = dataContainer.dataset.chartdata;
        let rawData;
        try { rawData = JSON.parse(rawDataString); } 
        catch (e) { rawData = {}; }

        if (rawData.labels && rawData.labels.length > 0) {
            const chartLabels = rawData.labels;
            const dataValues = rawData.data;
            const backgroundColors = chartLabels.map(() => getColor());
            const borderColors = backgroundColors.map(c => c.replace('0.85', '1'));
            
            new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    parsing: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed;
                                    if (label) { label += ': '; }
                                    label += new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(value);
                                    const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                    const percentage = (value / total * 100);
                                    label += ` (${percentage.toFixed(1)}%)`;
                                    return label;
                                }
                            }
                        },
                        // ZMIANA: Przywrócono pełną konfigurację datalabels
                        datalabels: {
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total * 100);
                                return percentage > 1.5 ? percentage.toFixed(1) + '%' : '';
                            },
                            color: '#fff',
                            font: { weight: 'bold', family: 'Poppins', size: 11 },
                            textStrokeColor: 'rgba(0,0,0,0.5)',
                            textStrokeWidth: 2
                        }
                        // ZMIANA: Usunięto obiekt 'centerText'
                    }
                }
            });
        }
    }

    // Obsługa przycisku dla rocznej analizy Gemini
    const generateYearlyBtn = document.getElementById('generateYearlySummaryBtn');
    const yearlyContainer = document.getElementById('geminiYearlySummaryContainer');
    const yearlyContent = document.getElementById('geminiYearlySummaryContent');
    const selectedYearForSummary = document.getElementById('year_select').value;

    if(generateYearlyBtn && yearlyContainer && yearlyContent) {
        generateYearlyBtn.addEventListener('click', async function() {
            this.disabled = true;
            const originalButtonHtml = this.innerHTML;
            this.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Generowanie...`;
            
            yearlyContent.innerHTML = '<p class="text-info">Pobieranie rocznej analizy od AI. To może chwilę potrwać...</p>';
            yearlyContainer.style.display = 'block';

            try {
                const response = await fetch(`{{ url_for('main.api_get_yearly_summary') }}?year=${selectedYearForSummary}`);
                const data = await response.json();
                if (response.ok) {
                    yearlyContent.innerHTML = data.summary_html;
                } else {
                    yearlyContent.innerHTML = `<p class="text-danger">Wystąpił błąd: ${data.error || 'Nieznany błąd serwera'}</p>`;
                }
            } catch(error) {
                yearlyContent.innerHTML = '<p class="text-danger">Nie można połączyć się z serwerem.</p>';
            } finally {
                this.disabled = false;
                this.innerHTML = originalButtonHtml;
            }
        });
    }
});
</script>
{% endblock %}